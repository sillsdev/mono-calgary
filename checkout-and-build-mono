#!/bin/sh

#	checkout-and-build-mono
#
#	Check out mono from svn, apply our patches, and build and install mono.
#
#	Neil Mayhew - 2009-05-12

REVISION=144586
PROJECTS="libgdiplus mcs mono"
DIRECTORIES="libgdiplus mono"

[ -z "${MONO_PREFIX}" ] && MONO_PREFIX="/usr/local"

set -e

echo $0: Starting ...

if [ -e $0.config ]; then
	. $0.config

	if [ "$OLD_ARCH" != "$(uname -m)" ]; then
		echo $0: Switching architecture. Doing a 'make clean'
		for DIR in $DIRECTORIES
		do
			[ -d $DIR ] && (cd $DIR; make clean)
		done
	fi
fi

echo $0: Reverting and cleaning mono svn working copy if exists
# Don't try to revert or clean if svn wasn't checked out yet.
[ -d .svn ] && svn revert -R . && for dir in $PROJECTS
do
	svn-clean $dir
done

echo $0: Checking out mono ...
svn co -r$REVISION --depth empty svn://anonsvn.mono-project.com/source/trunk .
svn up -r$REVISION $PROJECTS
cd mcs/class/Mono.Data.Tds
svn up -r125609
cd -
cd mcs/class/System.Data/System.Data.SqlClient
svn up -r125609
cd -

echo $0: Applying our patches ...
for PATCH in *.patch
do
	patch -p0 -i $PATCH
done

echo $0: Building mono ...
for DIR in $DIRECTORIES
do
	(cd $DIR; ./autogen.sh --prefix=$MONO_PREFIX; make)
done

echo OLD_ARCH=$(uname -m) > $0.config

echo $0: Installing mono ...
for DIR in $DIRECTORIES
do
	(cd $DIR; sudo make install)
done

echo $0: Finished successfully.
