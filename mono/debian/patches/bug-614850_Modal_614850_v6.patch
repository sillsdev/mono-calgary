From bd27d4d9f94d3d53369da1af66f4bc6922f937b3 Mon Sep 17 00:00:00 2001
From: Quilt patch <unknown@unknown.com>
Date: Tue, 30 Aug 2011 16:56:35 +0200
Subject: [PATCH] bug-614850_Modal_614850_v6

FWNX-398 Fixing modal dialogs so parents and children behave correctly
---
 .../System.Windows.Forms/Form.cs                   |   16 +++++++++-------
 1 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/mcs/class/Managed.Windows.Forms/System.Windows.Forms/Form.cs b/mcs/class/Managed.Windows.Forms/System.Windows.Forms/Form.cs
index 9fc4c25..c41b920 100644
--- a/mcs/class/Managed.Windows.Forms/System.Windows.Forms/Form.cs
+++ b/mcs/class/Managed.Windows.Forms/System.Windows.Forms/Form.cs
@@ -1793,14 +1793,13 @@ namespace System.Windows.Forms {
 				XplatUI.UngrabWindow(capture_window);
 			}
 
-			var disable = new List<Form> ();
-			foreach (Form form in Application.OpenForms)
-				if (form.Enabled)
-					disable.Add (form);
-			foreach (Form form in disable){
-				disabled_by_showdialog.Add (form);
-				form.Enabled = false;
+			lock (Application.OpenForms) {
+				foreach (Form form in Application.OpenForms)
+					if (form.Enabled == true)
+						disabled_by_showdialog.Add(form);
 			}
+			foreach (Form form in disabled_by_showdialog)
+				form.Enabled = false;
 			modal_dialogs.Add(this);
 
 #if not
@@ -2091,6 +2090,9 @@ namespace System.Windows.Forms {
 		[EditorBrowsable(EditorBrowsableState.Advanced)]
 		protected virtual void OnActivated(EventArgs e)
 		{
+//			if (!this.Enabled)
+//				return; // prevent Activating of disabled form.
+
 			EventHandler eh = (EventHandler)(Events [ActivatedEvent]);
 			if (eh != null)
 				eh (this, e);
-- 
1.7.4.1

